# Laboratoire 21

ğŸ“¦ Un [projet serveur et un projet client](../../static/files/labo21.zip) vous sont fournis. N'exÃ©cutez pas tout de suite le serveur, il y aura un modÃ¨le Ã  ajouter, une migration Ã  crÃ©er puis Ã  exÃ©cuter plus tard.

ğŸ¨ La librairie `ImageSharp` est dÃ©jÃ  installÃ©e sur le serveur.

## ğŸ“¸ Il y a dÃ©faut tÃ´t

L'objectif sera de permettre Ã  l'utilisateur de sÃ©lectionner une image, lâ€™envoyer au serveur, puis lâ€™ajouter dans la BD et dans le File System du serveur.

### 1 - RequÃªte et formulaire client

[ğŸ’¡](/notes/rencontre11.1#-envoyer-un-fichier-au-serveur) Modifiez lâ€™`<input>` de type `file` et exploitez `useRef` pour accÃ©der au fichier joint par lâ€™utilisateur.

Produisez un **FormData** qui contiendra lâ€™image et envoyez le **FormData** au serveur dans une requÃªte `POST`. (Il se peut que vous deviez modifier lâ€™URL de la requÃªte plus tard sachant que l'action n'existe pas encore)

:::warning

La requÃªte sera dans le **hook** `usePictureAPI`, mais il faut construire **FormData**  dans le composant `Home`. Vous pourrez envoyer le **FormData** sous forme de paramÃ¨tre Ã  `postPicture` dans le hook. (Le type du paramÃ¨tre sera `any`)

:::

### 2 - Ajouter une action POST serveur

[ğŸ’¡](/notes/rencontre11.1#-sauvegarder-une-image-sur-le-serveur) ComplÃ©tez la classe `Picture.cs` qui servira de modÃ¨le pour les images. Elle nâ€™aura que 3 propriÃ©tÃ©s. Ce modÃ¨le nâ€™a absolument pas besoin dâ€™exister cÃ´tÃ© client. Une fois le modÃ¨le finalisÃ© et sauvegardÃ©, crÃ©ez une migration et mettez Ã  jour la base de donnÃ©es.

Dans le contrÃ´leur relativement vide fourni, complÃ©tez lâ€™action `POST` qui recevra le fichier et lâ€™ajoutera dans la **BD** et le **File System**.

On veut une **version originale** de lâ€™image et une **version de taille rÃ©duite** avec une **hauteur de 200 pixels**.

<center>![Dossier pour les images](../../static/img/labo21/imageFolder.png)</center>

Bien entendu, pour le moment on ne peut pas afficher ces images dans la page Web.

:::warning

Des dossiers existent dÃ©jÃ  pour les images, vÃ©rifiez le rÃ©pertoire du serveur.

:::

## ğŸ¦ Le petit oiseau va sortir, attrapez-le

Lâ€™objectif pour cette Ã©tape sera dâ€™envoyer la liste des ids de toutes les images au projet **Next.js**. On nâ€™a pas besoin dâ€™envoyer les `FileName` et les `MimeType`, juste les ids.

### 3 - Envoyer les ids des images au client

ComplÃ©tez une action `GET` qui retourne simplement la liste de tous les ids des images dans la base de donnÃ©es. (Donc une `List<int>`)
Votre return pourrait ressembler Ã  ceci :

`return Ok(pictures.Select(p => p.Id));`

### 4 - Recevoir les ids cÃ´tÃ© client

Assurez-vous simplement de recevoir la **liste dâ€™ids** grÃ¢ce Ã  `useEffect`. Ã‡a ne sera pas suffisant pour pouvoir afficher les images, mais on y est presque.

<center>![Liste d'ids](../../static/img/labo21/ids.png)</center>

## ğŸ–¼ Sages commes des images

Nous allons permettre au serveur de retourner des fichiers images pour pouvoir les afficher dans le HTML.

### 5 - Ajouter une action GET cÃ´tÃ© serveur

[ğŸ’¡](/notes/rencontre11.1#-afficher-une-image-sur-le-client) En vous inspirant des notes de cours, retournez le fichier associÃ© Ã  lâ€™id demandÃ©.

Nâ€™oubliez pas de permettre de choisir entre les tailles Â« large Â» et Â« small Â».

### 6 - Afficher les images cÃ´tÃ© client

[ğŸ’¡](/notes/rencontre11.1#-afficher-une-image-sur-le-client) Dans le HTML, modifiez lâ€™attribut `src` pour demander lâ€™image au serveur en format small, pour chaque id dâ€™image existante. (La liste d'ids reÃ§ue par le client permet d'afficher chaque image, individuellement, Ã  l'aide d'une requÃªte dans le `src`.)

De plus, il faut que cliquer sur une image lâ€™affiche en format large dans un autre onglet. (Utilisez un Ã©lÃ©ment `<a>` et mettez la bonne requÃªte dans son attribut `href`, Ã§a ouvrira une page qui contiendra juste la grande image.)

<center>![Liste d'images](../../static/img/labo21/pictures.png)</center>

## ğŸš® On va en prendre une autre

Pour cette Ã©tape, nous allons rendre fonctionnels les petits Â« X Â» cÃ´tÃ© client pour supprimer les images.

### 7 - Ajouter un action DELETE cÃ´tÃ© serveur

[ğŸ’¡](/notes/rencontre11.1#-supprimer-une-image-du-serveur) Inspirez-vous de lâ€™action Delete dans les notes de cours pour trouver lâ€™image dans le **DbContext** et la supprimer. (Nâ€™oubliez pas de supprimer ses deux copies sur le disque Ã©galement)

Simplement retourner `Ok()` est convenable.

### 8 - Envoyer la requÃªte cÃ´tÃ© client

Il faudra lancer une requÃªte qui fournit simplement lâ€™id de lâ€™image Ã  supprimer. La requÃªte est dÃ©jÃ  prÃªte, il manque seulement un Ã©vÃ©nement `onClick` dans le HTML qui appelle correctement une fonction.

## ğŸ‡ Un c'est bien, mais cinquante-douze c'est mieux

Pour cette Ã©tape **qui vous servira beaucoup dans le TP4**, on souhaite permettre Ã  lâ€™utilisateur de poster plusieurs images simultanÃ©ment plutÃ´t quâ€™une seule Ã  la fois. Il y aura plusieurs changements Ã  faire pour que ce soit possible.

### 9 - Modifier le client

[ğŸ’¡](/notes/rencontre11.1#-envoyer-un-fichier-au-serveur) Dans lâ€™`<input>` de type file, ajoutez lâ€™attribut HTML `multiple` (il nâ€™a pas de valeur), qui permet de sÃ©lectionner plusieurs fichiers Ã  la fois.

Lorsque vous meublerez le formData, vous allez devoir `.append()` un Ã  plusieurs fichiers maintenant. Comme chaque **clÃ©** doit Ãªtre unique, visez quelque chose comme `"image0"`, `"image1"`, `"image2"`, etc.

Quand il y avait un seul fichier, on allait le chercher avec `.current.files[0]`. Pour les suivants, il suffira de remplacer le 0 par 1, puis 2, puis 3, etc. ou encore de parcourir `for (let f of ...current.files)`

### 10 - Modifier l'action POST du serveur

[ğŸ’¡](/notes/rencontre11.1#-sauvegarder-une-image-sur-le-serveur) Un peu la mÃªme idÃ©e que cÃ´tÃ© client : comme on va recevoir un Ã  plusieurs fichiers, il faudra mettre une boucle dans le code et faire `GetFile( â€¦ )` jusquâ€™Ã  ce quâ€™on ait Ã©puisÃ© tous les fichiers.

Assurez-vous que Ã§a fonctionne une fois que vous avez terminÃ©.