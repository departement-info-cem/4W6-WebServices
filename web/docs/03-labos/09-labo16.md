# Laboratoire 16

<center>![BanniÃ¨re du site](../../static/img/labo15/banner.png)</center>

Des [projets de dÃ©part](../../static/files/labo16.zip) Angular et ASP.NET Core vous sont fournis. Orchestrez bien `npm install`, `npm run dev` et `dotnet ef database update`.

**Mise en situation dont personne n'avait besoin** : M. Robidoux gÃ¨re un zoo de dinosaures, mais il a besoin d'un systÃ¨me pour rÃ©pertorier tous les incidents qui surviennent pour simplifier la collaboration avec ses assureurs.

Vous devrez complÃ©ter le systÃ¨me existant, essentiellement en implÃ©mentant la crÃ©ation (Post) de `zookeeper`, de `dinosaur` et d'`incident` ainsi que la suppression (Delete) de `zookeeper` et de `dinosaur`. Comme ces entitÃ©s ont des relations, Ã§a pourrait Ãªtre dÃ©licat.

## ğŸ˜µ Qu'est-ce qui se passe ici

Commencez par jeter un coup d'oeil aux deux projets. Portez principalement attention aux classes `Zookeeper`, `Dinosaur` et `Incident`. Assurez-vous de bien comprendre le type de **relation** entre chacune de ses classes.

En rÃ©sumÃ© :
* Un `Zookeeper` est responsable de **0 Ã  N** `Dinosaur`.
* Un `Dinosaur` est gÃ©rÃ© par **1** `Zookeeper` et est associÃ© Ã  **0 Ã  N** `Incident`.
* Un `Incident` est associÃ© Ã  **1 Ã  N** `Dinosaur`.

## ğŸ¥š Donner naissance est difficile

L'application permet dÃ©jÃ  de crÃ©er des `Zookeeper`. VÃ©rifiez le code de l'action `PostZookeeper()` sur le serveur : il est ultra simple et reÃ§oit directement un `Zookeeper` en paramÃ¨tre. C'est similaire au code par dÃ©faut pour `POST` quand on gÃ©nÃ¨re un contrÃ´leur. Pour crÃ©er des `Dinosaur` et des `Incident`, ce sera moins simple ... il faudra utiliser des **DTOs** !

<center>![Liste de zookeepers](../../static/img/labo15/zookeepers.png)</center>

### 1 - CrÃ©er des dinosaures

CrÃ©ez une action `Post` dans `DinosaursController` permettant de crÃ©er des nouveaux dinosaures.

Il faudra aussi complÃ©ter une requÃªte dans le hook `useDinoAPI` **cÃ´tÃ© client**. Ce **hook** est dÃ©jÃ  bien intÃ©grÃ© au composant `Home` et pour toute la durÃ©e du labo on ne touchera jamais Ã  `Home`.

[ğŸ’¡](/notes/rencontre8.2#-one-to-many-1) Comme un `Dinosaur` doit absolument Ãªtre associÃ© Ã  un `Zookeeper` dÃ¨s sa crÃ©ation, il faudra aussi transmettre l'id du `Zookeeper` associÃ©. Il faudra crÃ©er un [DTO](/notes/rencontre8.2#-data-transfer-objects) pour transfÃ©rer le **nom** et l'**espÃ¨ce** du `Dinosaur` ainsi que l'**id** de son `Zookeeper`.

Une fois le `Zookeeper` trouvÃ©, le `Dinosaur` crÃ©Ã© et la BD sauvegardÃ©e, retournez le nouveau `Dinosaur` crÃ©Ã© comme ceci : 

```cs
return Ok(dinosaur);
```

Gardez Ã  l'esprit que, cÃ´tÃ© client, `response.data` contiendra le nouveau `Dinosaur`, Ã  ajouter dans l'Ã©tat `dinosaurs`.

<center>![Liste de dinosaures](../../static/img/labo15/dinosaurs.png)</center>

:::info

Si vous rencontrez une **erreur 400** ğŸ, c'est-Ã -dire une erreur de **validation**, c'est parce que vous n'envoyez pas les bonnes donnÃ©es au serveur. Est-ce que les donnÃ©es envoyÃ©es portent les mÃªmes **noms** que les **propriÃ©tÃ©s** de votre **DTO** ? Est-ce que les **types** sont compatibles et valides ?

:::

### 2 - CrÃ©er des incidents

CrÃ©ez une action `Post` dans `IncidentsController` permettant de crÃ©er des nouveaux incidents.

[ğŸ’¡](/notes/rencontre8.2#-many-to-many-1) Lors de la crÃ©ation d'un `Incident`, nous voudrons **immÃ©diatement** indiquer Ã  quels `Dinosaur` cet `Incident` est associÃ©. Il faudra donc envoyer la liste des ids des `Dinosaur` associÃ©s au serveur. Vous aurez encore besoin d'un DTO pour y arriver.

Notez que la date de l'incident pourra Ãªtre dÃ©terminÃ©e sur le serveur, Ã  l'aide de `DateTime.Now`.

Une fois la liste de `Dinosaur` trouvÃ©e, le nouvel `Incident` crÃ©Ã© et la BD sauvegardÃ©e, retournez le nouvel `Incident` crÃ©Ã© comme ceci :

```cs
return Ok(dinosaur);
```

Si jamais 0 `Dinosaur` ont Ã©tÃ© trouvÃ©s Ã  l'aide des ids reÃ§us, retournez une erreur :

```cs
return BadRequest(new { Message = "Les ids reÃ§us sont invalides ou vides." });
```

`response.data` contiendra le nouvel `Incident`.

<center>![Liste d'incidents](../../static/img/labo15/incidents.png)</center>

## ğŸ”ª Supprimer n'est pas plus facile

CongÃ© de **DTOs** ! Pour supprimer une donnÃ©e, il suffit d'envoyer son `id` avec la requÃªte. Cela dit, les **clÃ©s Ã©trangÃ¨res** (relations de nos objets) complexifieront la suppression.

### 3 - Supprimer des dinosaures

[ğŸ’¡](/notes/rencontre8.2#-suppression) Lorsqu'on supprime un `Dinosaur`, on doit commencer par supprimer tous ses `Incident` associÃ©s **SI CE DINOSAURE Ã‰TAIT LE DERNIER Ã‰TANT ASSOCIÃ‰ Ã€ L'INCIDENT** (Il faudra un petit `if` avec `maListe.Count == 1` par exemple !), sinon on laisse dans la base de donnÃ©es un `Indicent` un peu inutile. Les incidents qui sont encore associÃ©s Ã  au moins un autre dinosaure n'ont pas Ã  Ãªtre supprimÃ©s.

CrÃ©ez une action `Delete` dans le `DinosaursController` **cÃ´tÃ© serveur** et complÃ©tez le `DinosaurService` **cÃ´tÃ© client**.

### 4 - Supprimer des zookeepers

[ğŸ’¡](/notes/rencontre8.2#-suppression) Lorsqu'on supprime un `Zookeeper`, on doit aussi supprimer tous ses `Dinosaur` associÃ©s, sinon il y aura une erreur en lien avec une **clÃ© Ã©trangÃ¨re** dans la base de donnÃ©es. 

Comme pour la **question prÃ©cÃ©dente**, il faudra encore supprimer certains `Incident` si un `Dinosaur` associÃ© qu'on s'apprÃªte Ã  supprimer Ã©tait le **dernier associÃ© Ã  l'incident**. 

CrÃ©ez une action `Delete` dans le `ZookeepersController` **cÃ´tÃ© serveur** et complÃ©tez le `DinosaurService` **cÃ´tÃ© client**.
