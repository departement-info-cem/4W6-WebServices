# Laboratoire 16

<center>![Banni√®re du site](../../static/img/labo15/banner.png)</center>

Un [projet de d√©part](../../static/files/labo15.zip) Angular et ASP.NET Core vous sont fournis.

**Mise en situation dont personne n'avait besoin** : M. Robidoux g√®re un zoo de dinosaures, mais il a besoin d'un syst√®me pour r√©pertorier tous les incidents qui surviennent pour simplifier la collaboration avec ses assureurs.

Vous devrez compl√©ter le syst√®me existant, essentiellement en impl√©mentant la cr√©ation (Post) de `zookeeper`, de `dinosaur` et d'`incident` ainsi que la suppression (Delete) de `zookeeper` et de `dinosaur`. Comme ces entit√©s ont des relations, √ßa pourrait √™tre d√©licat.

## üòµ Qu'est-ce qui se passe ici

Commencez par jeter un coup d'oeil aux deux projets. Portez principalement attention aux classes `Zookeeper`, `Dinosaur` et `Incident`. Assurez-vous de bien comprendre le type de relation entre chacune de ses classes.

En r√©sum√© :
* Un `Zookeeper` est responsable de plusieurs `Dinosaur`.
* Un `Dinosaur` est g√©r√© par un `Zookeeper` et est associ√© √† plusieurs `Incident`.
* Un `Incident` est associ√© √† plusieurs `Dinosaur`.

## ü•ö Donner naissance est difficile

### 1 - Cr√©er des zookeepers

Cr√©ez une action `Post` dans `ZookeepersController` permettant de cr√©er des nouveaux gardiens.

Il faudra aussi compl√©ter une requ√™te dans le `DinosaurService` **c√¥t√© client**.

Bien que `Zookeeper` ait une relation avec `Dinosaur`, comme un `Zookeper` peut exister sans `Dinosaur`,
√ßa devrait √™tre _ultra simple_ et ressembler √† un `Post` auto-g√©n√©r√©.

<center>![Liste de gardiens](../../static/img/labo15/zookeepers.png)</center>

### 2 - Cr√©er des dinosaures

Cr√©ez une action `Post` dans `DinosaursController` permettant de cr√©er des nouveaux dinosaures.

Il faudra aussi compl√©ter une requ√™te dans le `DinosaurService` **c√¥t√© client**.

[üí°](/cours/rencontre8.1#-cr√©ation) Comme un `Dinosaur` doit absolument √™tre associ√© √† un `Zookeeper` d√®s sa cr√©ation, il faudra aussi transmettre l'id du `Zookeeper` associ√©.

[üí°](/cours/rencontre8.1#-data-transfer-objects) Vous aurez besoin d'un DTO pour y arriver.

<center>![Liste de dinosaures](../../static/img/labo15/dinosaurs.png)</center>

### 3 - Cr√©er des incidents

Cr√©ez une action `Post` dans `IncidentsController` permettant de cr√©er des nouveaux incidents.

Il faudra aussi compl√©ter une requ√™te dans le `DinosaurService` **c√¥t√© client**.

[üí°](/cours/rencontre8.1#-cr√©ation) Lors de la cr√©ation d'un `Incident`, nous voudrons **imm√©diatement** indiquer √† quels `Dinosaur` cet `Incident` est associ√©. Il faudra donc envoyer la liste des ids des `Dinosaur` associ√©s au serveur.

[üí°](/cours/rencontre8.1#-data-transfer-objects) Vous aurez besoin d'un DTO pour y arriver.

<center>![Liste d'incidents](../../static/img/labo15/incidents.png)</center>

## üî™ Supprimer n'est pas plus facile

### 4 - Supprimer des dinosaures

[üí°](/cours/rencontre8.1#-suppression) Lorsqu'on supprime un `Dinosaur`, on doit aussi supprimer tous ses `Incident` associ√©s **SI CE DINOSAURE √âTAIT LE DERNIER √âTANT ASSOCI√â √Ä L'INCIDENT** (Il faudra un petit `if` avec `maListe.Count == 1` par exemple !), sinon on laisse dans la base de donn√©es un `Indicent` un peu inutile.

Cr√©ez une action `Delete` dans le `DinosaursController` **c√¥t√© serveur** et compl√©tez le `DinosaurService` **c√¥t√© client**.

### 5 - Supprimer des zookeepers

[üí°](/cours/rencontre8.1#-suppression) Lorsqu'on supprime un `Zookeeper`, on doit aussi supprimer tous ses `Dinosaur` associ√©s, sinon il y aura une erreur en lien avec une **cl√© √©trang√®re** dans la base de donn√©es. 

Comme pour la **question pr√©c√©dente**, il faudra encore supprimer certains `Incident` si un `Dinosaur` associ√© qu'on s'appr√™te √† supprimer √©tait le **dernier associ√© √† l'incident**. 

Cr√©ez une action `Delete` dans le `ZookeepersController` **c√¥t√© serveur** et compl√©tez le `DinosaurService` **c√¥t√© client**.

## ‚öô Rendez-vous service en utilisant les services

:::warning

C'est important de se pratiquer √† utiliser des services, mais pour all√©ger le code, il y aura seulement des services dans le TP3 et dans le TP4. (Les prochains labos et l'examen final n'auront pas de services)

:::

### 6 - Compl√©ter trois services

[üí°](/cours/rencontre8.1#-services) Pour chacune des trois entit√©s qui existent, compl√©tez un **service**. L'objectif est de retirer le `DbContext` des trois contr√¥leurs. 

:::info

Vous risquez d'avoir environ **9+ m√©thodes** √† cr√©er dans vos 3 services. (Au total) √áa peut sembler long, mais il s'agit principalement de **d√©placer du code** et de **d√©couper des m√©thodes**. Vous pouvez vous inspirer des services dans les notes de cours, mais il y aura quelques diff√©rences.

Gardez √† l'esprit que le plus important est de **d√©barrasser toutes les lignes de code impliquant `_context` des contr√¥leurs**.

:::

Ci-dessous, quelques pistes pour chacune des 7 actions existantes dans vos contr√¥leurs :

1. `GetZookeeper`¬†et `GetDinosaur`

Pour ces deux actions, il suffira de cr√©er une m√©thode `GetAll()` dans `ZookeeperService` et `DinosaurService`. **100% copi√©-coll√© des notes de cours**.

<hr/>

2. `PostZookeeper`

Plut√¥t simple aussi, il suffira de cr√©er une m√©thode `Create()` dans `ZookeeperService`. **100% copi√©-coll√© des notes de cours**.

<hr/>

3. `PostDinosaur`

Vous aurez besoin deux deux m√©thodes dans les services :

* `Get()` (ou _GetOne_) dans `ZookeeperService` pour obtenir le `Zookeeper` responsable du `Dinosaur`.
* `Create()` dans `DinosaurService`.

√áa veut dire que deux services seront inject√©s dans `DinosaursController`.

<hr/>

4. `PostIncident`

Vous aurez besoin de deux m√©thodes dans les services :

* `Get()` (Un _GetOne_) dans `DinosaurService` pour obtenir chaque `Dinosaur` dont l'`id` a √©t√© re√ßu.
* `Create()` dans `IncidentService`.

√áa veut dire que deux services seront inject√©s dans `IncidentsController`.

<hr/>

5. `DeleteDinosaur`

Vous aurez besoin d'**une √† trois** m√©thodes dans les services :

* `Delete()` dans `DinosaurService`. Comme il y aura une boucle qui supprime des `Incident`, on a deux choix... :
  * Soit on encapsule cette boucle dans la m√©thode `Delete()` de `DinosaurService()` (Plus simple)
  * Soit on cr√©e un `Get()` ET un `Delete()` dans `IncidentService`. (Plus complexe)

<hr/>

6. `DeleteZookeeper`

Vous aurez besoin d'**une √† quatre** m√©thodes dans les services :

* `Delete()` dans `ZookeeperService`. Encore une fois, pour la boucle, on a deux choix... :
  * On la met dans le `Delete()`¬†de `ZookeeperService` (Moins bien... ‚õî)
  * On utilise `Get()` et `Delete()`¬†dans `DinosaurService`. (Mieux ! ‚úÖ) Si vous faites ceci, vous aurez aussi besoin d'un `Get()` dans `ZookeeperService` pour commencer par obtenir le `Zookeeper` avant la boucle.

:::info

Gardez √† l'esprit qu'il y a plusieurs mani√®res de d√©couper les fonctionnalit√©s dans les services... L'important est de **d√©barrasser le DbContext des contr√¥leurs** ET d'√©viter la **r√©p√©tition de code** dans les contr√¥leurs.

:::


