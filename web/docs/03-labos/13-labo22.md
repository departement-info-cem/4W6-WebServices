# Laboratoire 22

<center>![BanniÃ¨re dÃ©corative](../../static/img/labo21/banner.png)</center>

C'est le dernier laboratoire ! ğŸ˜­ TÃ©lÃ©chargez les [projets de dÃ©part](../../static/files/labo22.zip) en sÃ©chant vos larmes ğŸ’¦

## ğŸ˜© Jeu de rÃ´les

### 1 - CrÃ©er des rÃ´les

[ğŸ’¡](/notes/rencontre11.2#-crÃ©er-un-rÃ´le) CrÃ©er deux rÃ´les nommÃ©s **student** et **corruptedTeacher** dans le seed.

### 2 - Attribuer des rÃ´les

[ğŸ’¡](/notes/rencontre11.2#-crÃ©er-un-rÃ´le) Toujours dans le seed, attribuez le rÃ´le **student** Ã  **Pielle-Arexandre** et Ã  **Masie-Carrandra**.
De plus, attribuez le rÃ´le **corruptedTeacher** Ã  **maxou**.

### 3 - Limiter l'accÃ¨s Ã  des actions

[ğŸ’¡](/notes/rencontre11.2#-limiter-laccÃ¨s-aux-actions) L'action `PostReview`Â doit seulement Ãªtre utilisable par des **student**. De plus, l'action `DeleteReview` doit seulement Ãªtre utilisable par **l'auteur d'un review OU par un corruptedTeacher**. (Un **corruptedTeacher** peut supprimer tous les reviews et un **student** peut seulement supprimer ses propres reviews.)

Assurez-vous de bien tester toutes ces nouvelles contraintes et n'hÃ©sitez pas Ã  crÃ©er de nouveaux utilisateurs sans rÃ´le en vous inscrivant.

<center>
|Utilisateur|Mot de passe|RÃ´le|
|-|-|-|
|maxou|allo|corruptedTeacher|
|Pielle-Arexandre|allo|student|
|Masie-Carrandra|allo|student|
</center>

## ğŸ“œ Qui suis-je ?

L'objectif de cette section sera d'afficher les donnÃ©es de l'utilisateur cÃ´tÃ© Angular. Comme le modÃ¨le `User` n'existe pas cÃ´tÃ© client et qu'on n'a pas accÃ¨s Ã  la base de donnÃ©es et aux rÃ´les, il faudra Ãªtre un peu crÃ©atif. (Mais pas beaucoup)

<center>![Profil de l'utilisateur](../../static/img/labo21/profile.png)</center>

### 4 - Modifier la connexion

[ğŸ’¡](/notes/rencontre11.2#-donnÃ©es-de-connexion) CÃ´tÃ© serveur, dans l'action `Login`, ajoutez deux choses dans **l'objet JSON qui contient le token** :

* Le pseudonyme de l'utilisateur.
* La liste de strings avec tous les rÃ´les de l'utilisateur.

Ces deux informations ne sont pas censÃ©es Ãªtre difficiles Ã  trouver dans le code existant.

### 5 - Afficher le profil

[ğŸ’¡](/notes/rencontre11.2#-donnÃ©es-de-connexion) CÃ´tÃ© client, dans le **hook** `useReviewAPI`, remarquez que la requÃªte `Login` retourne `x.data`, qui contient maintenant deux informations supplÃ©mentaires. Trouvez oÃ¹ la fonction `login()` est appelÃ©e dans le composant `Home`, et stockez le **pseudo** et les **rÃ´les** Ã  deux endroits :

1. Dans les Ã©tats `username` et `roles`. (Serviront pour des **affichages conditionnels**)
2. Dans le stockage de session. (Permettra de faire perdurer les donnÃ©es si on rÃ©actualise la page)

âœ Modifiez le HTML de `Home` ... :

* Affichez le pseudo de l'utilisateur connectÃ©.
* Affichez les rÃ´les de l'utilisateur connectÃ©. (Pas besoin de `.map()`, juste `{roles}`)
* Cacher toute la boÃ®te du profil lorsque le pseudo de l'utilisateur est `null`.

<center>![Profil de l'utilisateur](../../static/img/labo21/profile.png)</center>

:::note

HÃ©las, ce fonctionnement est brisÃ© si on rÃ©actualise la page. Pas de panique : c'est pour Ã§a qu'on a stockÃ© le pseudo et les rÃ´les dans le **stockage de session** !

:::

â° Ajoutez un `useEffect()` dans `Home` pour :

* RÃ©cupÃ©rer le pseudo et les rÃ´les, qui sont dans le **stockage de session**.
* Modifier les deux Ã©tats appropriÃ©s pour restaurer les donnÃ©es identitaires.

DÃ©sormais, le panneau du profil devrait Ãªtre fonctionnel en tout temps, mÃªme si on rÃ©actualise la page !

ğŸ”Œ Un dernier dÃ©tail important : la dÃ©connexion ! Modifiez la fonction `logoff()` dans `Home` :

* Elle doit supprimer le **token**, le **pseudo** et les **rÃ´les** du stockage de sessuib.
* Elle doit rÃ©initialiser les deux Ã©tats appropriÃ©s.

Assurez-vous qu'en vous dÃ©connectant, le panneau du profil devienne invisible. (Et qu'il le reste lorsqu'on rÃ©actualise la page)

## ğŸ‘€ Ce qu'on ne voit pas ne nous fait pas de mal

### 6 - Cacher des Ã©lÃ©ments selon le profil

Ã€ l'aide de la forme `{ condition && Ã©lÃ©ment HTML }` et des **Ã©tats** qu'on a remplis, vous devrez cacher certains Ã©lÃ©ments dans la page Web.

<center>![CrÃ©er un review](../../static/img/labo21/studentOnly.png)</center>

ğŸ“ La zone pour crÃ©er un `Review` doit seulement Ãªtre visible pour les utilisateurs avec le rÃ´le `student`. (L'instruction en JavaScript `monTableau.includes(valeur)`, qui retourne un boolÃ©en, sera utile !)

<center>![Supprimer un review](../../static/img/labo21/authorOnly.png)</center>

âŒ Le bouton pour supprimer un `Review` doit seulement Ãªtre visible pour l'auteur du `Review` ET pour tous les `corruptedTeacher`. (Comparez le pseudo dans l'Ã©tat avec le nom de l'auteur du `Review`...)

:::tip

> Un instant ! L'affichage des `Reviews` est dans un autre composant.

Ce n'est pas un problÃ¨me : il y a un **Context** qui permet de partager les valeurs des Ã©tats `username` et `roles` au composant `Post`.

:::

Testez avec les quatre types d'utilisateurs (aucun rÃ´le, corruptedTeacher, student auteur et student pas auteur) si tous les Ã©lÃ©ments graphiques sont bien cachÃ©s au bon moment.

<center>
|Utilisateur|Mot de passe|RÃ´le|
|-|-|-|
|maxou|allo|corruptedTeacher|
|Pielle-Arexandre|allo|student|
|Masie-Carrandra|allo|student|
</center>

<center>ğŸ‘„ Merci d'avoir complÃ©tÃ© le dernier laboratoire ğŸ‘„</center>
