# Laboratoire 17

<center>![BanniÃ¨re du site](../../static/img/labo17/banner.png)</center>

ğŸ“¦ TÃ©lÃ©chargez les [projets de dÃ©part](../../static/files/labo17.zip).

## ğŸ‘¤ ProblÃ¨mes identitaires

La **gestion des utilisateurs** est dÃ©jÃ  totalement complÃ©tÃ©e cÃ´tÃ© **serveur**. Il manque seulement quelques morceaux cÃ´tÃ© **client**. Vous devrez dÃ©jÃ  complÃ©ter la gestion des utilisateurs dans le **TP3**, alors on vous Ã©pargne cela pour le moment sachant que ce n'est pas trÃ¨s *stimulant*. 

### ğŸ”Œ 1 - Connexion

[ğŸ’¡](/notes/rencontre9.1#-connexion) Terminez le code de la requÃªte pour la connexion cÃ´tÃ© **client**, dans le **hook** `useWeebAuth`.  (Tout est prÃªt cÃ´tÃ© **serveur**) PlutÃ´t que de ranger le **token ğŸ”‘** dans un **Ã©tat**, rangez-le dans le **stockage de session**.

Tentez de vous **inscrire**, puis de vous **connecter**. Assurez-vous que le **token ğŸ”‘** est bien reÃ§u.

<center>![RÃ©ception du token](../../static/img/labo17/token.png)</center>

### ğŸ“¶ 2 - Intercepteur

[ğŸ’¡](/notes/rencontre9.1#-intercepteurs) CrÃ©ez un intercepteur pour ne pas avoir Ã  joindre le **token** constamment, Ã  chaque requÃªte nÃ©cessitant l'authentification. Le fichier `/app/auth-interceptor.ts` est dÃ©jÃ  crÃ©Ã©, il faudra juste le complÃ©ter.

En compÃ©tant les exercices 4 Ã  6, plus bas, vous aurez la confirmation que votre intercepteur fonctionne ou pas. (Vous aurez des erreurs **401** si votre intercepteur est mal codÃ© ou que vous oubliez de vous connecter)

## ğŸ™ CinÃ©ma alternatif

Vous allez coder plusieurs **actions** cÃ´tÃ© **serveur** qui exploitent l'authentification. CÃ´tÃ© **client**, les requÃªtes sont dÃ©jÃ  toutes prÃªtes dans le **hook** `useWeebAPI`.

### ğŸ‘¥ 3 - Ajouter une relation

[ğŸ’¡](/notes/rencontre8.2#-many-to-many) Ajoutez une **relation** entre les classes `User.cs` et `Anime.cs`. On souhaite qu'un `User` puisse Ãªtre Â« abonnÃ© Â» Ã  **plusieurs** `Anime`. On souhaite aussi qu'un `Anime` puisse Ãªtre Â« suivi Â» par **plusieurs** `User`.

[ğŸ’¡](/notes/rencontre8.1#-base-de-donnÃ©es) Une fois les deux **propriÃ©tÃ©s de navigation** ajoutÃ©es et les fichiers bien sauvegardÃ©s, faites une nouvelle **migration** et mettez **Ã  jour** la base de donnÃ©es. (Il faudra arrÃªter le serveur pendant ces opÃ©rations) Dans les coulisses, **Entity Framework** va crÃ©er une **table de liaison** entre `User` et `Anime`.

[ğŸ’¡](/notes/rencontre8.2#-objets-json-infinis) Attention ! â›” Il y aura un `[JsonIgnore]` Ã  placer quelque part pour Ã©viter un **objet JSON infini** quand on `GET` les `Anime`.

### ğŸ“© 4 - CrÃ©er un anime

[ğŸ’¡](/notes/rencontre9.1#%EF%B8%8F%EF%B8%8F-dÃ©terminer-qui-envoie-la-requÃªte) ComplÃ©ter la requÃªte `PostAnime`. Il n'y a pas de `DTO`Â Ã  utiliser, donc c'est un `POST` plutÃ´t simple, sauf que :

* Il faut dÃ©terminer **qui** envoie la requÃªte.
* On veut immÃ©diatement associer cet `User` Ã  l'`Anime` qui est crÃ©Ã©. (On est automatiquement **abonnÃ©** Ã  un `Anime` si on est celui / celle qui l'a `POST` )

Dans tous les cas, pour le moment, assurez-vous que l'anime est bien crÃ©Ã© et visible ensuite :

<center>![Liste des animes](../../static/img/labo17/animes.png)</center>

### ğŸ“¬ 5 - Obtenir mes animes

[ğŸ’¡](/notes/rencontre9.1#%EF%B8%8F%EF%B8%8F-dÃ©terminer-qui-envoie-la-requÃªte) ComplÃ©ter la requÃªte `GetMyAnimes`. Le but est simplement de retourner la liste des `Anime` auquel l'utilisateur qui envoie la requÃªte est **abonnÃ©**. C'est censÃ© Ãªtre simple (max. 3 lignes de code)

Les animes que vous avez `POST` vous-mÃªmes devraient dÃ©jÃ  Ãªtre prÃ©sents :

<center>![Liste de mes animes](../../static/img/labo17/myAnimes.png)</center>

Si ce n'est pas le cas, c'est qu'il y a un souci avec votre `PostAnime`. Je vous mets au dÃ©fi de demander de l'aide Ã  l'enseignant ğŸ˜³

### ğŸŸ 6 - S'abonner Ã  un anime

La derniÃ¨re action, `SubscribeAnime`, permet, lorsqu'on appuie sur le bouton Â« Choisir Â», de **s'abonner / se dÃ©sabonner** d'un anime. L'action vÃ©rifie qui envoie la requÃªte, trouve l'`Anime` associÃ© Ã  l'`id`Â reÃ§u, puis :

* L'utilisateur est dÃ©jÃ  abonnÃ© Ã  l'`Anime` : il perd sa relation avec l'`Anime`. (DÃ©sabonnÃ©)
... ou ...
* L'utiliasteur n'est pas abonnÃ© Ã  l'`Anime` : il obtient une relation avec l'`Anime`. (AbonnÃ©)

<center>![S'abonner Ã  un anime](../../static/img/labo17/subscribe.png)</center>

Si Ã§a fonctionne bien, appuyer sur Â« Choisir Â» devrait permettre d'ajouter ou de retirer un `Anime` de la liste Â« Vos animes Â».

## âš™ Une classe serviable

*Oh non ...* des services. 

### ğŸ“ 7 - Fonctions d'un service

[ğŸ’¡](/notes/rencontre9.1#-exemples) Parmi les 5 **actions** du `AnimesController`, il y en a ...

* Une qui est dÃ©jÃ  adaptÃ©e au service. (`GetAnime`)
* Une qui n'aura pas besoin d'Ãªtre adaptÃ©e car elle ne manipule pas le `_context`. (`GetMyAnimes`, Ã  moins que vous l'ayez codÃ©e... de maniÃ¨re *suspecte*)
* Deux que vous devrez adapter.

Un squelette de **mÃ©thode** est dÃ©jÃ  prÃ©parÃ© pour ces deux **actions** dans le `AnimeService`. Il y a aussi la **mÃ©thode** `GetOne()` dans le service, qui pourrait vous servir dans `AnimesController`.

Notez que vous devrez continuer d'utiliser le `UserManager` dans le contrÃ´leur, car on ne veut pas **injecter un service dans un autre service** â›”. (`UserManager` *est* un service)

:::note

Il y a plusieurs bonnes maniÃ¨res de crÃ©er des **mÃ©thodes** dans un **service**. L'important est de s'assurer de ne plus utiliser le `_context` dans le `AnimesController` !

:::

Une fois que c'est fait :

* Retirez l'injection du `_context` dans `AnimesController`.
* Testez au moins ces trois actions Ã  l'aide de la page Web pour Ãªtre sÃ»r(e) que tout fonctionne encore.